<%# layouts/_session_manager.html.erb %>
<% if current_user %>
  <% 
    # Cache for longer and include avatar URL to avoid repeated S3 calls
    avatar_url = current_user.avatar.present? ? current_user.avatar.small.url : nil 
  %>
  <% cache ["session_manager_v6", current_user.id, current_user.username, avatar_url], expires_in: 1.hour do %>
    <div class="relative" data-controller="dropdown">
      <!-- Dropdown trigger -->
      <a class="flex items-center whitespace-nowrap transition duration-150 ease-in-out motion-reduce:transition-none" 
         href="#" 
         data-action="click->dropdown#toggle">
        <% if current_user.avatar.present? %>
          <%= image_tag current_user.avatar.small.url, 
              class: "h-[35px] w-[35px] rounded-full object-cover border-2 border-indigo-500", 
              loading: "lazy",
              decoding: "async",
              alt: "#{current_user.username}'s avatar" %>
        <% else %>
          <div class="h-[35px] w-[35px] rounded-full bg-indigo-500 flex items-center justify-center border-2 border-indigo-500">
            <span class="text-white font-semibold text-sm">
              <%= current_user.username.first.upcase %>
            </span>
          </div>
        <% end %>
      </a>
      
      <!-- Dropdown menu -->
      <ul class="absolute right-0 left-auto z-[1000] float-left m-0 hidden min-w-max list-none overflow-hidden rounded-lg border-none bg-white bg-clip-padding text-left text-base shadow-lg dark:bg-neutral-800" 
          data-dropdown-target="menu">
        <li>
          <%= link_to "Profile", profile_path, 
              class: "block w-full whitespace-nowrap bg-white px-4 py-2 text-sm font-normal text-neutral-700 hover:bg-zinc-200/60 focus:bg-zinc-200/60 focus:outline-none active:bg-zinc-200/60 active:no-underline dark:bg-neutral-800 dark:text-white dark:hover:bg-neutral-700 dark:focus:bg-neutral-700 dark:active:bg-neutral-700" %>
        </li>
        <li>
          <%= link_to "Settings", edit_user_registration_path, 
              class: "block w-full whitespace-nowrap bg-white px-4 py-2 text-sm font-normal text-neutral-700 hover:bg-zinc-200/60 focus:bg-zinc-200/60 focus:outline-none active:bg-zinc-200/60 active:no-underline dark:bg-neutral-800 dark:text-white dark:hover:bg-neutral-700 dark:focus:bg-neutral-700 dark:active:bg-neutral-700" %>
        </li>
        <li>
          <%= link_to "Sign out", destroy_user_session_path, 
              method: :delete, 
              class: "block w-full whitespace-nowrap bg-white px-4 py-2 text-sm font-normal text-neutral-700 hover:bg-zinc-200/60 focus:bg-zinc-200/60 focus:outline-none active:bg-zinc-200/60 active:no-underline dark:bg-neutral-800 dark:text-white dark:hover:bg-neutral-700 dark:focus:bg-neutral-700 dark:active:bg-neutral-700" %>
        </li>
      </ul>
    </div>
  <% end %>
<% else %>
  <div class="relative flex items-center">
    <%= link_to 'Sign-up', new_user_registration_path, class: "btn-primary mr-2" %>
    <%= link_to 'Log-in', new_user_session_path, class: "btn-primary mr-2" %>
  </div>
<% end %>